# PowerSchool Portal - GitHub Actions CI
name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      agent_task:
        description: 'Task for agent development cycle'
        required: false
        default: 'full-validation'
        type: choice
        options:
          - full-validation
          - scraper-only
          - mcp-only
          - alerts-only
          - ui-only
          - ground-truth
          - quick-check
          - unit-only
          - integration-only
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.12'
  POWERSCHOOL_URL: ${{ secrets.POWERSCHOOL_URL }}
  POWERSCHOOL_USERNAME: ${{ secrets.POWERSCHOOL_USERNAME }}
  # Password is base64 encoded - will be decoded in job steps
  POWERSCHOOL_PASSWORD_B64: ${{ secrets.POWERSCHOOL_PASSWORD }}

jobs:
  #----------------------------------------------------------------------------
  # Fast Feedback Jobs
  #----------------------------------------------------------------------------
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install ruff mypy
          pip install -e ".[dev]"

      - name: Run ruff check
        run: ruff check src/ tests/

      - name: Run ruff format check
        run: ruff format --check src/ tests/

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports || true
        continue-on-error: true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short \
            --junitxml=reports/unit-results.xml \
            -m "unit or not (integration or e2e)" || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: reports/

  #----------------------------------------------------------------------------
  # Integration Tests
  #----------------------------------------------------------------------------
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --tb=short \
            --junitxml=reports/integration-results.xml \
            -m "integration or not (unit or e2e)" || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: reports/

  #----------------------------------------------------------------------------
  # E2E Tests (Live PowerSchool)
  #----------------------------------------------------------------------------
  e2e-tests:
    name: E2E Tests (Live)
    runs-on: ubuntu-latest
    needs: [integration-tests]
    # Only run on main branch push - skip on workflow_dispatch since agent-dev-cycle handles it
    # This prevents concurrent PowerSchool logins which cause session conflicts
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          playwright install chromium
          playwright install-deps chromium

      - name: Create reports directory
        run: mkdir -p reports

      - name: Decode PowerSchool password
        run: |
          if [ -n "$POWERSCHOOL_PASSWORD_B64" ]; then
            DECODED=$(echo "$POWERSCHOOL_PASSWORD_B64" | base64 -d 2>/dev/null || echo "$POWERSCHOOL_PASSWORD_B64")
            echo "POWERSCHOOL_PASSWORD=$DECODED" >> $GITHUB_ENV
          fi

      - name: Run scraper to populate database
        run: |
          echo "=== Running PowerSchool scraper ==="
          python scripts/scrape_full.py --headless 2>&1 || {
            echo "⚠️ Scraper failed, checking partial results..."
          }

          echo ""
          echo "=== Checking scraper output ==="
          ls -la raw_html/ 2>/dev/null || echo "raw_html/ not created"

          if [ -f raw_html/full_data.json ]; then
            echo "✅ full_data.json exists"
            python -c "import json; d=json.load(open('raw_html/full_data.json')); print(f'Students: {len(d.get(\"students\", []))}'); print(f'Current student: {d.get(\"current_student\")}')"
          else
            echo "❌ full_data.json not found"
          fi

          echo ""
          echo "=== Loading data into database ==="
          python scripts/load_data.py 2>&1 || {
            echo "⚠️ Data loading had issues"
          }

          echo ""
          echo "=== Verifying database ==="
          if [ -f powerschool.db ]; then
            echo "✅ Database exists at $(pwd)/powerschool.db"
            ls -la powerschool.db
            python -c "import sqlite3; c=sqlite3.connect('powerschool.db'); print('Tables:', [r[0] for r in c.execute(\"SELECT name FROM sqlite_master WHERE type='table'\").fetchall()])"
          else
            echo "❌ Database not found at $(pwd)/powerschool.db"
            find . -name "*.db" -type f 2>/dev/null || echo "No .db files found"
          fi

      - name: Run E2E tests
        run: |
          pytest tests/e2e/ -v \
            --tb=long \
            --junitxml=reports/e2e-results.xml \
            -m "e2e or not (unit or integration)" \
            2>&1 | tee reports/e2e-output.log || true

      - name: Generate test summary
        if: always()
        run: python scripts/generate_test_summary.py > reports/test-summary.json || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            reports/
            raw_html/
            powerschool.db
          retention-days: 7

      - name: Upload test summary for agents
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-test-summary
          path: reports/test-summary.json

  #----------------------------------------------------------------------------
  # Agent Development Workflow
  #----------------------------------------------------------------------------
  agent-dev-cycle:
    name: Agent Development Cycle
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          playwright install chromium
          playwright install-deps chromium

      - name: Create reports directory
        run: mkdir -p reports

      - name: Decode PowerSchool password
        run: |
          if [ -n "$POWERSCHOOL_PASSWORD_B64" ]; then
            DECODED=$(echo "$POWERSCHOOL_PASSWORD_B64" | base64 -d 2>/dev/null || echo "$POWERSCHOOL_PASSWORD_B64")
            echo "POWERSCHOOL_PASSWORD=$DECODED" >> $GITHUB_ENV
          fi

      - name: Run scraper for E2E tasks
        run: |
          TASK="${{ github.event.inputs.agent_task }}"
          # Only run scraper for tasks that need E2E database
          case "$TASK" in
            "scraper-only"|"mcp-only"|"alerts-only"|"full-validation")
              echo "=== Running PowerSchool scraper for E2E task: $TASK ==="
              python scripts/scrape_full.py --headless 2>&1 || {
                echo "⚠️ Scraper failed, checking partial results..."
              }

              echo ""
              echo "=== Checking scraper output ==="
              ls -la raw_html/ 2>/dev/null || echo "raw_html/ not created"

              if [ -f raw_html/full_data.json ]; then
                echo "✅ full_data.json exists"
                python -c "import json; d=json.load(open('raw_html/full_data.json')); print(f'Students: {len(d.get(\"students\", []))}'); print(f'Current student: {d.get(\"current_student\")}')"
              fi

              echo ""
              echo "=== Loading data into database ==="
              python scripts/load_data.py 2>&1 || echo "⚠️ Data loading had issues"

              echo ""
              echo "=== Verifying database ==="
              if [ -f powerschool.db ]; then
                echo "✅ Database exists at $(pwd)/powerschool.db"
                python -c "import sqlite3; c=sqlite3.connect('powerschool.db'); print('Tables:', [r[0] for r in c.execute(\"SELECT name FROM sqlite_master WHERE type='table'\").fetchall()])"
              else
                echo "❌ Database not found"
              fi
              ;;
            *)
              echo "Skipping scraper for task: $TASK"
              ;;
          esac

      - name: Run agent task
        id: agent-task
        run: |
          TASK="${{ github.event.inputs.agent_task }}"
          echo "Running task: $TASK"
          mkdir -p reports/screenshots

          case "$TASK" in
            "scraper-only")
              pytest tests/e2e/test_scraper.py -v --tb=long --junitxml=reports/results.xml || true
              ;;
            "mcp-only")
              pytest tests/e2e/test_mcp_tools.py -v --tb=long --junitxml=reports/results.xml || true
              ;;
            "alerts-only")
              pytest tests/e2e/test_alerts.py -v --tb=long --junitxml=reports/results.xml || true
              ;;
            "ui-only")
              # Seed database for UI tests
              cd streamlit-chat && python seed_data.py && cd ..
              # Run UI tests
              pytest tests/e2e/test_streamlit_ui.py -v --tb=long --junitxml=reports/results.xml || true
              ;;
            "ground-truth")
              python scripts/validate_ground_truth.py | tee reports/ground-truth.txt
              ;;
            "quick-check")
              pytest tests/unit/ tests/integration/ -v --tb=short -x --junitxml=reports/results.xml || true
              ;;
            "unit-only")
              pytest tests/unit/ -v --tb=short --junitxml=reports/results.xml || true
              ;;
            "integration-only")
              pytest tests/integration/ -v --tb=short --junitxml=reports/results.xml || true
              ;;
            "full-validation")
              pytest tests/e2e/ -v --tb=long --junitxml=reports/results.xml || true
              ;;
          esac

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ui-screenshots-${{ github.run_id }}
          path: reports/screenshots/
          retention-days: 7

      - name: Generate agent report
        if: always()
        run: |
          python scripts/generate_test_summary.py > reports/test-summary.json || true
          python scripts/generate_agent_report.py || true
          cat reports/test-summary.json

      - name: Upload agent results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-results-${{ github.run_id }}
          path: reports/

  #----------------------------------------------------------------------------
  # Generate Reports
  #----------------------------------------------------------------------------
  generate-reports:
    name: Generate Reports
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: e2e-test-results
          path: .
        continue-on-error: true

      - name: Generate reports
        run: |
          mkdir -p reports
          python scripts/generate_agent_report.py || true

      - name: Upload final reports
        uses: actions/upload-artifact@v4
        with:
          name: final-reports
          path: reports/

  #----------------------------------------------------------------------------
  # PR Comment with Results (for human review)
  #----------------------------------------------------------------------------
  comment-results:
    name: Post Results to PR
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Download unit test results
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: reports/
        continue-on-error: true

      - name: Download integration test results
        uses: actions/download-artifact@v4
        with:
          name: integration-test-results
          path: reports/
        continue-on-error: true

      - name: Generate test summary from PR tests
        run: |
          mkdir -p reports
          python scripts/generate_test_summary.py > reports/test-summary.json || echo '{"error": "Failed to generate summary"}' > reports/test-summary.json
          echo "=== Generated test summary ==="
          cat reports/test-summary.json

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = {};
            try {
              const content = fs.readFileSync('reports/test-summary.json', 'utf8');
              summary = JSON.parse(content);
            } catch (e) {
              summary = { error: 'Could not parse test summary', details: e.message };
            }

            const totals = summary.totals || {};
            const testResults = summary.test_results || {};
            const status = summary.status || 'unknown';

            // Determine status based on actual test results
            const hasTests = totals.tests > 0;
            const hasFailed = totals.failed > 0;
            const statusEmoji = hasFailed ? '❌' : (hasTests ? '✅' : '⚠️');
            const statusText = hasFailed ? 'failed' : (hasTests ? 'passed' : 'no tests found');

            // Build failure details if any
            let failureDetails = '';
            for (const [suite, results] of Object.entries(testResults)) {
              if (results.failure_details && results.failure_details.length > 0) {
                failureDetails += `\n**${suite} failures:**\n`;
                for (const f of results.failure_details) {
                  failureDetails += `- \`${f.name}\`: ${f.message.substring(0, 100)}...\n`;
                }
              }
            }

            const body = `## ${statusEmoji} Test Results

| Metric | Value |
|--------|-------|
| Total Tests | ${totals.tests || 0} |
| Passed | ${totals.passed || 0} |
| Failed | ${totals.failed || 0} |
| Skipped | ${totals.skipped || 0} |

${hasFailed ? '⚠️ Some tests failed. Check artifacts for details.' + failureDetails : (hasTests ? '✅ All tests passed!' : '⚠️ No test results found. Check if tests ran correctly.')}

<details>
<summary>Test Suite Details</summary>

\`\`\`json
${JSON.stringify(testResults, null, 2)}
\`\`\`
</details>

> **Note:** PR checks run unit and integration tests only. E2E tests run on merge to main.
`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
